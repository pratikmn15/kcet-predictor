{% extends 'base.html' %}
{% block colleges %}

<div class="container my-4 glass1">
    <h2 class="mb-4" id="target">Available Colleges</h2>
    
    <div id="download-container" style="display: none; margin-bottom: 20px;">
        <button id="download-pdf" class="btn btn-primary">Download PDF</button>
    </div>
    
    <div class="table-container">
        <div class="table-wrapper">
            <table class="table table-hover">
                <thead>
                    <tr id="table-header">
                    </tr>
                </thead>
                <tbody id="table-data">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
  const form = document.getElementById('formInfo');
  let currentData = null;
  let currentRound = null;
  
  form.addEventListener('submit', function (event) {
    event.preventDefault();

    const formData = new FormData(form);
    currentRound = formData.get('round');

    fetch('/submit', {
      method: 'POST',
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        data = data.message;
        currentData = data;
        const tableHeader = document.getElementById('table-header');
        const tableData = document.getElementById('table-data');
        tableHeader.innerHTML = '';
        tableData.innerHTML = '';
        data.columns.forEach(col => {
          const th = document.createElement('th');
          th.textContent = col;
          tableHeader.appendChild(th);
        });
        data.rows.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
          });
          tableData.appendChild(tr);
        });
        alerts = document.getElementById('alerts');
        alerts.innerHTML = '';
        Round = String(formData.get('round'));
        console.log(Round);
        let round = "";
        if (Round === '2023r1') {
          round = '2023 Round 1';
        }
        else if (Round === '2023r2') {
          round = '2023 Round 2';
        }
        else if (Round === '2023r3') {
          round = '2023 Round 3';
        }
        else if (Round === '2024r1') {
          round = '2024 Round 1';
        }
        else if (Round === '2022r3') {
          round = '2022 Round 3';
        }
        else if (Round === '2022r2') {
          round = '2022 Round 2';
        }
        else if (Round === '2022r1') {
          round = '2022 Round 1';
        }
        else if (Round === '2024r2') {
          round = '2024 Round 2';
        }
        else if (Round === '2024r3') {
          round = '2024 Round 3';
        }
        alerts.textContent = "Showing results for " + round + ", " + formData.get('cat') + " category";
        
        document.getElementById('download-container').style.display = 'block';
        
        document.getElementById('target').scrollIntoView({ behavior: 'smooth' });
      })
      .catch(error => {
        console.error('Error:', error);
        responseMessage.textContent = 'An error occurred!';
      });
  });

  // PDF download functionality
  document.getElementById('download-pdf').addEventListener('click', function() {
    if (!currentData || !currentRound) return;
    
    const downloadBtn = this;
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'Generating PDF...';
    
    fetch('/generate-pdf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ...currentData,
        round: currentRound
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.blob();
    })
    .then(blob => {
      // Create a link to download the PDF
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `kcet_results.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'Download PDF';
    })
    .catch(error => {
      console.error('Error:', error);
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'Download PDF';
      alert('Failed to generate PDF. Please try again.');
    });
  });
</script>

{% endblock colleges %}